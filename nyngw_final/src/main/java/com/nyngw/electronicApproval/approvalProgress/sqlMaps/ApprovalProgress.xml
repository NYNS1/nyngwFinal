<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nyngw.electronicApproval.approvalProgress.dao.ApprovalProgressDao">

	<!-- 한 사원이 결재스탭에 포함 된 결재번호들을 검색 -->
	<select id="ap_selectEaNumberByMemId" parameterType="string" resultType="string">
		select distinct ast_ea_number from APPROVAL_step where ast_mem_number = #{mem_number}
	</select>

	<!-- 가장 높은 결재 우선순위 ast_ea_number-->
	<select id="selectLastAstPriority" parameterType="string" resultType="int">
		select max(rnum) from
		(select rownum rnum, a.* 
		from (select * from approval_step 
		where (ast_ea_number = #{ast_ea_number} and ast_al_number ='A') 
		or (ast_ea_number = #{ast_ea_number} and ast_al_number ='B')  
		order by ast_al_number desc, ast_priority asc) a)
	</select>
	
	<!-- 자신의 결재 우선순위 ast_ea_number / ast_mem_number-->
	<select id="selectOneAstPriority" parameterType="map" resultType="int">
		select rnum from
		(select rownum rnum, a.* 
		from (select * from approval_step
		where (ast_ea_number = #{ast_ea_number} and ast_al_number ='A') 
		or (ast_ea_number = #{ast_ea_number} and ast_al_number ='B')  
		order by ast_al_number desc, ast_priority asc) a)
		where ast_mem_number = #{ast_mem_number}
	</select>
	
	<!-- 결재이력의 가장 높은 우선순위 ah_ea_number-->
	<select id="selectLastApprovalHistory" parameterType="string" resultType="int">
		select nvl(max(substr(ah_ast_number,4)),0) from approval_history where ah_ea_number= #{ah_ea_number}
	</select>
	
	<select id="selectEA" resultType="com.nyngw.dto.Electronic_ApprovalVO" parameterType="string">
		select * from Electronic_Approval where ea_number = #{ea_number}
	</select>
	
	
	<select id="selectAstMemNumberByEaNumber" resultType="com.nyngw.dto.Approval_StepVO" parameterType="com.nyngw.dto.Approval_StepVO">
		select ast_mem_number, ast_priority 
		from approval_Step 
		where ast_al_number = #{ast_al_number} 
		and ast_ea_number = #{ast_ea_number} 
		order by 2
	</select>
	
	<insert id="insertApprovalHistory" parameterType="com.nyngw.dto.Approval_HistoryVO">
		insert into Approval_History 
		values ('ah'||ah_seq.nextval,#{ah_code_number},#{ah_ast_number},#{ah_ea_number},#{ah_comment})
	</insert>
	
	
	<select id="selectCA" resultType="com.nyngw.dto.Electronic_ApprovalVO">
		select * from Electronic_Approval where ea_status = '결재완료'
	</select>
	
	<select id="selectRA" resultType="com.nyngw.dto.Electronic_ApprovalVO">
		select * from Electronic_Approval where ea_status = '반려'
	</select>
	
	<select id="selectLastAstPriorityOfA" resultType="int">
		select count(rnum) from
		(select rownum rnum, a.* 
		from (select * from approval_step 
		where ast_ea_number = #{ast_ea_number} and ast_al_number ='A'
		order by ast_al_number desc, ast_priority asc) a)
	</select>
	
	<select id="selectLastAstPriorityOfB" resultType="int">
		select count(rnum) from
		(select rownum rnum, a.* 
		from (select * from approval_step 
		where ast_ea_number = #{ast_ea_number} and ast_al_number ='B'
		order by ast_al_number desc, ast_priority asc) a)
	</select>
	
	<select id="selectAllByApprovalAstNumber" resultType="string">
		select ast_al_number from approval_step where ast_ea_number = #{ah_ea_number} and ast_number = #{ah_ast_number}
	</select>
	
	<select id="selectAhAstNumberByEaNumber" parameterType="string" resultType="list">
		select ah_ast_number from approval_history where ah_ea_number = #{ah_ea_number}
	</select>
	
	<select id="selectAstAlNumberByAstNumber" parameterType="map" resultType="string">
		select ast_al_number from approval_step where ast_number  = #{ast_number} and ast_ea_number = #{ah_ea_number}
	</select>

</mapper>